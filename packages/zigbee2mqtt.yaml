sensor:
  - platform: rest
    name: Zigbee2MQTT coordinator latest version
    resource: https://api.github.com/repos/Koenkk/Z-Stack-firmware/releases/latest
    headers:
      Accept: application/vnd.github.v3+json
    value_template: >
      {% for asset in value_json.assets %}
        {% if asset.name.startswith("CC2652R_coordinator_") %}
          {{ asset.name.split("CC2652R_coordinator_")[1].split(".zip")[0] }}
        {% endif %}
      {% endfor %}
    scan_interval: 86400

template:
  - binary_sensor:
      - name: Zigbee2MQTT coordinator update
        state: >
          {{
            not is_state("sensor.zigbee2mqtt_bridge_coordinator_version", states("sensor.zigbee2mqtt_coordinator_latest_version"))
          }}
        device_class: update
        availability: >
          {{
            states("sensor.zigbee2mqtt_bridge_coordinator_version") not in ["unknown", "unavailable"] and
            states("sensor.zigbee2mqtt_coordinator_latest_version") not in ["unknown", "unavailable"]
          }}

automation:
  - id: zigbee2mqtt_coordinator_update_notification
    alias: "Notificatie: Zigbee2MQTT coordinator versie update"
    mode: restart
    max_exceeded: silent
    triggers:
      - alias: When there is an update
        trigger: state
        entity_id: binary_sensor.zigbee2mqtt_coordinator_update
        from: "off"
        to: "on"
    actions:
      - alias: Send the notification
        action: notify.discord
        data:
          message: ""
          target: !secret discord_updates
          data:
            embed:
              author:
                name: Zigbee2MQTT
                icon_url: https://www.zigbee2mqtt.io/logo.png
              title: Coordinator update
              description: |
                Versie **{{ states("sensor.zigbee2mqtt_coordinator_latest_version") }}** is beschikbaar!
                De huidige versie is {{ states("sensor.zigbee2mqtt_bridge_coordinator_version") }}.
                https://github.com/Koenkk/Z-Stack-firmware/releases/latest

  - id: notification_zigbee_devices_unavailable
    alias: "Notificatie: Zigbee apparaten niet bereikbaar"
    mode: single
    triggers:
      - trigger: numeric_state
        entity_id: sensor.count_zigbee_unavailable
        below: 1
        variables:
          color: 3066993 # Green
          message: Alle Zigbee apparaten zijn weer bereikbaar
      - trigger: numeric_state
        entity_id: sensor.count_zigbee_unavailable
        above: 0
        for:
          hours: 3 # Prevent spamming if a device is offline for a little while
        variables:
          color: 15158332 # Red
          message: |
            De volgende Zigbee apparaten zijn niet bereikbaar:
            {{
              state_attr("sensor.count_zigbee_unavailable", "unavailable")
              | map("regex_replace", "^(.*)$", "- \\1")
              | join("\n")
            }}
    conditions:
      - alias: Prevent all triggers after reboot
        condition: template
        value_template: >
          {{ (now() - as_datetime(states("sensor.uptime"))).total_seconds() > 300 }}
    actions:
      - alias: Send the notification
        action: notify.discord
        data:
          message: ""
          target: !secret discord_monitoring
          data:
            embed:
              author:
                name: Zigbee2MQTT
                icon_url: https://github.com/Koenkk/zigbee2mqtt/raw/master/images/logo.png
              color: |
                {{ color | int }}
              description: |
                {{ message }}
