template:
  - trigger:
      - platform: event
        event_type: key_value_set
      - platform: event
        event_type: key_value_unset
      - platform: event
        event_type: key_value_clear
    sensor:
      - unique_id: key_value_store
        name: Key value store
        state: >-
          {{ now().isoformat() }}
        attributes:
          store: >
            {% set current = this.attributes.get('store', {}) %}
            {% if trigger.event.event_type == 'key_value_set' %}
              {% set new = { trigger.event.data.key: { 'value': trigger.event.data.value, 'timestamp': now().isoformat() } } %}
              {{ dict(current, **new) }}
            {% elif trigger.event.event_type == 'key_value_unset' %}
              {{ dict(current.items() | rejectattr('0', 'eq', trigger.event.data.key)) }}
            {% elif trigger.event.event_type == 'key_value_unset' %}
              {{ {} }}
            {% endif %}
