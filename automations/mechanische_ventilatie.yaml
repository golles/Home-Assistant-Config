- id: mechanische_ventilatie_douchen
  alias: Mechanische ventilatie tijdens douchen
  initial_state: on
  mode: restart
  trigger:
    - platform: homeassistant
      event: start # Listen to start event to make sure we're not staying forever in high mode.
    - platform: state
      entity_id: binary_sensor.douche_beweging_occupancy
      from: 'off'
      to: 'on'
    - platform: state
      entity_id: binary_sensor.douche_beweging_occupancy
      from: 'on'
      to: 'off'
      for:
        minutes: 5
  action:
    - choose:
      # Occupancy detected.
      - conditions:
        - "{{ trigger.entity_id == 'binary_sensor.douche_beweging_occupancy' }}"
        - "{{ is_state('binary_sensor.douche_beweging_occupancy', 'on') }}"
        sequence:
          - service: script.ventilation_set_preset_mode
            data:
              preset_mode: high

      # Occupancy no longer detected. First go to low and then set a timer.
      - conditions:
        - "{{ trigger.entity_id == 'binary_sensor.douche_beweging_occupancy' }}"
        - "{{ is_state('binary_sensor.douche_beweging_occupancy', 'off') }}"
        sequence:
          - service: script.ventilation_set_preset_mode
            data:
              preset_mode: low

          - delay:
              seconds: 5

          - service: script.ventilation_set_speed_timer
            data:
              speed: high
              timer: 10

      # HA start.
      default:
        - service: script.ventilation_set_preset_mode
          data:
            preset_mode: low
