- id: goedemorgen_bericht
  alias: Goedemorgen bericht bij 1e beweging in de woonkamer
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.woonkamer_beweging
      to: "on"
  condition:
    - condition: state
      entity_id: media_player.lg_c9
      state: "off" 
    - condition: state
      entity_id: media_player.lg_soundbar
      state: 
        - "off"
        - idle
    - condition: state
      entity_id: binary_sensor.morning
      state: "on"
    - condition: template
      value_template: > # Don't trigger if it has been triggered in the lasy 6 hours.
        {{ as_timestamp(now()) - as_timestamp(state_attr("automation.goedemorgen_bericht_bij_1e_beweging_in_de_woonkamer", "last_triggered")) | int >= 6 * 60 * 60 }}
  action:
    - alias: Force update weather description
      service: homeassistant.update_entity
      target:
        entity_id: sensor.lokaal_weer_en_verkeer

    - alias: Set soundbar volume
      service: media_player.volume_set
      data:
        entity_id: media_player.lg_soundbar
        volume_level: 0.25 # 10 * 0.025

    - alias: Wait a little
      delay:
        seconds: 5

    - alias: Speak message
      service: tts.microsoft_say
      entity_id: media_player.lg_soundbar
      data:
        message: >-
          {% set good = ["Goedenacht", "Goedemorgen","Goedemiddag", "Goedeavond"] %}
          {% set day = ["maandag", "dinsdag", "woensdag", "donderdag", "vrijdag", "zaterdag", "zondag"][now().weekday()] %}
          {% set month = ["januari", "februari", "maart", "april", "mei", "juni", "juli", "augustus", "september", "oktober", "november", "december"][now().month-1] %}

          {{ good[(now().hour / 6) | int] }}!
          Vandaag is het {{ day }} {{ now().day }} {{ month }}.
          {% if state_attr("sensor.lokaal_weer_en_verkeer", "weatherDescription") in ["", None] %}
            {{ states("sensor.knmi_purmerend_korte_dagverwachting") }}
          {% else %}
            {{ state_attr("sensor.lokaal_weer_en_verkeer", "weatherDescription") | replace("km/uur", "kilometer per uur") }}
          {% endif %}
