- id: washing_machine_door_open_when_done
  alias: Wasmachine deur open als hij klaar is
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.wasmachine_operation_state
      from: Finished
      to: Ready
  condition:
    - condition: state
      entity_id: binary_sensor.wasmachine_door
      state: "on"
    - condition: state # Door should be closed.
      entity_id: binary_sensor.balkondeur_contact
      state: "off"
    - condition: state # Window should be closed.
      entity_id: binary_sensor.zolderraam_contact
      state: "off"
  action:
    - choose:
      - conditions:
        # When the fan is set to low, set it to high for a certain amount of time.
        - "{{ is_state_attr('fan.mechanische_ventilatie', 'percentage', 25) }}"
        sequence:
          - service: button.press
            target:
              entity_id: button.mechanische_ventilatie_30_minuten_hoog
    - choose:
      - conditions:
        # When the room temperature is below a certain value, switch the heating on.
        - "{{ state_attr('climate.zolder', 'temperature') | float(20) < 20 }}"
        sequence:
          - service: tado.set_climate_timer
            data:
              entity_id: climate.zolder
              time_period: "02:00:00"
              temperature: 23

- id: notification_washing_machine
  alias: "Notificatie: Wasmachine klaar (tv)"
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.wasmachine_operation_state
      from: Run
      to: Finished
  condition:
    - "{{ is_state('media_player.lg_c9', 'on') }}"
  action:
    - service: notify.lg_c9
      data:
        message: Wasmachine is klaar

# The washing machine remains sometimes unavailble. Reloading the integration to "fix" this
# Issue: https://github.com/home-assistant/core/issues/66063
- id: reload_home_connect
  alias: Wasmachine - Herlaad Home Connect integratie
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.zolder_power
      above: 10
      for:
        minutes: 2
    - platform: numeric_state
      entity_id: sensor.zolder_power
      below: 2
      for:
        minutes: 2
  condition:
    - condition: numeric_state
      entity_id: sensor.runtime
      above: 200 # Should be a little higher than the minutes in the triggers, to deal with reboot.
  action:
    - alias: Notify about this
      service: notify.sander
      data:
        title: Home Connect
        message: Integratie wordt herladen

    - alias: Reload Home Connect integration
      service: homeassistant.reload_config_entry
      target:
        entity_id: switch.wasmachine_power
