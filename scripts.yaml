everything_off:
  description: Turn everything off in the house
  mode: single
  fields:
    exclude_entity_ids:
      description: entity_ids to exclude
  sequence:
    - service: homeassistant.turn_off
      data:
        entity_id: >
          {{
            (
              expand(
                states.light
                | selectattr('state', 'eq', 'on')
                | rejectattr('attributes.is_hue_group')
                | rejectattr('attributes.entity_id')
              ) +
              expand(
                states.media_player
                | rejectattr('state', 'in', ['off', 'unavailable'])
              )
            )
              | rejectattr('entity_id', 'in', exclude_entity_ids)
              | map(attribute='entity_id')
              | join(', ')
          }}
